name: Build Loftify for TrollStore

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: 1. 拉取代码
        uses: actions/checkout@v4

      - name: 2. 安装最新版 Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: 3. 精准注入依赖重写
        run: |
          # 1. 先把文件中所有关于 intl 的版本限制都删掉，防止多处冲突
          sed -i '' '/intl:/d' pubspec.yaml
          
          # 2. 如果文件里已经有 dependency_overrides:，就在它下面插入一行
          # 如果没有，就在文件末尾创建它
          if grep -q "dependency_overrides:" pubspec.yaml; then
            sed -i '' '/dependency_overrides:/a\
            \  intl: 0.20.2' pubspec.yaml
          else
            echo "" >> pubspec.yaml
            echo "dependency_overrides:" >> pubspec.yaml
            echo "  intl: 0.20.2" >> pubspec.yaml
          fi
          
          # 打印后 30 行检查格式
          tail -n 30 pubspec.yaml
          
          flutter pub get
          
      - name: 4. 安装 iOS 原生依赖
        run: |
          cd ios
          rm -rf Podfile.lock
          # 这一步在 Mac 机器上非常重要，跳过它会导致插件无法在 iOS 运行
          pod install --repo-update
          cd ..

      - name: 5. 编译 iOS 工程 (免签名)
        run: |
          flutter build ios --release --no-codesign

      - name: 6. 封装为巨魔 IPA
        run: |
          mkdir -p Payload
          cp -r build/ios/iphoneos/Runner.app Payload/
          zip -r Loftify_TrollStore.ipa Payload

      - name: 7. 上传安装包
        uses: actions/upload-artifact@v4
        with:
          name: Loftify-Package
          path: Loftify_TrollStore.ipa
