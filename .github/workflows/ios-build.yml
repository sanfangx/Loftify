name: Build Loftify for TrollStore

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: 1. 拉取代码
        uses: actions/checkout@v4

      - name: 2. 安装最新版 Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: 3. 彻底重写依赖配置文件 (解决所有格式与冲突)
        run: |
          # 这一步我们不再搜索替换，而是直接删除旧的，建立一个修正后的依赖配置
          # 我们利用 Flutter 的全局覆盖功能
          cat <<EOF > fix_dependency.py
          import yaml
          import sys

          with open('pubspec.yaml', 'r') as f:
              data = yaml.safe_load(f)

          # 强制设置 SDK 范围
          data['environment']['sdk'] = '>=3.6.0 <4.0.0'
          
          # 注入或更新重写逻辑，解决 intl 冲突
          if 'dependency_overrides' not in data:
              data['dependency_overrides'] = {}
          data['dependency_overrides']['intl'] = '0.20.2'
          
          with open('pubspec.yaml', 'w') as f:
              yaml.dump(data, f)
          EOF

          # GitHub Actions 的 macOS 自带 Python3 和 PyYAML
          python3 -m pip install PyYAML
          python3 fix_dependency.py
          
          # 打印结果看看
          echo "--- 修改后的 pubspec.yaml ---"
          head -n 50 pubspec.yaml
          
          flutter pub get
          
      - name: 4. 安装 iOS 原生依赖 (CocoaPods)
        run: |
          cd ios
          # 清理可能导致报错的缓存
          rm -rf Podfile.lock
          pod install --repo-update
          cd ..

      - name: 5. 编译 iOS 工程 (免签名)
        run: |
          flutter build ios --release --no-codesign

      - name: 6. 制作巨魔 IPA
        run: |
          mkdir -p Payload
          cp -r build/ios/iphoneos/Runner.app Payload/
          zip -r Loftify_TrollStore.ipa Payload

      - name: 7. 上传安装包
        uses: actions/upload-artifact@v4
        with:
          name: Loftify-Final-Package
          path: Loftify_TrollStore.ipa
