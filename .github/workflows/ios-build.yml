name: Build Loftify for TrollStore

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: 1. 拉取代码
        uses: actions/checkout@v4

      - name: 2. 安装最新版 Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: 3. 彻底重写依赖配置文件 (使用 Dart 脚本)
        run: |
          # 创建一个 Dart 脚本来处理文件
          cat <<EOF > fix_pubspec.dart
          import 'dart:io';

          void main() {
            var file = File('pubspec.yaml');
            var lines = file.readAsLinesSync();
            var newLines = <String>[];
            
            bool hasDependencyOverrides = false;
            
            for (var line in lines) {
              // 1. 修正 SDK 版本要求
              if (line.contains('sdk:')) {
                newLines.add('  sdk: ">=3.6.0 <4.0.0"');
                continue;
              }
              // 2. 检查是否已经存在 dependency_overrides
              if (line.contains('dependency_overrides:')) {
                hasDependencyOverrides = true;
              }
              // 3. 移除旧的 intl 限制
              if (line.trim().startsWith('intl:')) {
                continue;
              }
              newLines.add(line);
            }

            // 4. 强行注入 intl 0.20.2
            if (hasDependencyOverrides) {
              // 如果已存在，就在该行下面注入
              int index = newLines.indexWhere((l) => l.contains('dependency_overrides:'));
              newLines.insert(index + 1, '  intl: 0.20.2');
            } else {
              // 如果不存在，在末尾添加
              newLines.add('\ndependency_overrides:');
              newLines.add('  intl: 0.20.2');
            }

            file.writeAsStringSync(newLines.join('\n'));
            print('pubspec.yaml 已成功修正');
          }
          EOF

          # 运行 Dart 脚本
          dart fix_pubspec.dart
          
          # 获取依赖
          flutter pub get
          
      - name: 4. 安装 iOS 原生依赖 (CocoaPods)
        run: |
          cd ios
          rm -rf Podfile.lock
          pod install --repo-update
          cd ..

      - name: 5. 编译 iOS 工程 (免签名)
        run: |
          flutter build ios --release --no-codesign

      - name: 6. 制作巨魔 IPA
        run: |
          mkdir -p Payload
          cp -r build/ios/iphoneos/Runner.app Payload/
          zip -r Loftify_TrollStore.ipa Payload

      - name: 7. 上传安装包
        uses: actions/upload-artifact@v4
        with:
          name: Loftify-Final-Package
          path: Loftify_TrollStore.ipa
